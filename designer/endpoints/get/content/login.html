<!DOCTYPE html>
<html>
    <head>
        <script>

            function fetchWithRedirect(headers, redirectUrl) {
                return fetch(location.href, { method: "POST", redirect: 'follow', headers, body:JSON.stringify({ redirectUrl: "/designer" } )})  //check if token is valid and redirect
                .then(function(response) {
                    return new Promise(function(resolve){
                        if (response.redirected) {
                            location.href = response.url;
                        } else {
                            resolve(response);
                        }
                    });
                })    
                .catch(function(err) {console.log(err);});
            }

            function login(username, secret) {
                if (typeof username === "string" && typeof secret === "string") {
                    fetchWithRedirect({username:username,secret:secret}).then(function(response) { //login and get a token
                        token = response.headers.get("token");
                        if (token) {
                            sessionStorage.setItem("token", token);
                        }
                        response.text().then(function(body) {
                            let jsonBody = { redirectUrl : null };
                            try {
                                jsonBody = JSON.parse(body);
                                const { redirectUrl } = jsonBody;
                                location.href = redirectUrl;
                            } catch {console.log("failed to parse body to json");}
                        });
                    });
                } else if (username && secret) {
                    if (username.value && secret.value) {
                        return login(username.value, secret.value);
                    }
                } else {
                    let token = sessionStorage.getItem("token");
                    fetchWithRedirect({token:token});  //check if token is valid and redirect
                }
            }
            login(); //this is to force a POST to the server to check the token.
        </script>
    </head>
    <body>
        <input type="input" id="username" placeholder="enter username here..."/>
        <input type="input" id="secret" placeholder="enter password here..."/>
        <input type="button" id="submit" value="Login" onclick="login(username, secret);"/>
        <a href="/register">Register</a>
    </body>
</html>